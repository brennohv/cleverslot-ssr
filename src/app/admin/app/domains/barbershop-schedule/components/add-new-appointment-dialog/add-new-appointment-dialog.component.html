<lib-modal-body
  [alignActions]="isCreationAppointmentLoading() ? 'center' : 'end'"
>
  <ng-container slot="modal-content">
    <form class="d-flex flex-column row-gap-3">
      <!-- Date section -->
      <div class="d-flex flex-column">
        <strong class="mb-3">
          <span [transloco]="I18N_PREFFIX + 'date-title'"></span
        ></strong>
        <lib-date-picker-input
          [minDate]="TODAY"
          [formControlRef]="newAppointmentForm.controls.date"
          [label]="I18N_PREFFIX + 'date-label' | transloco"
        >
        </lib-date-picker-input>
      </div>

      <!-- Service section -->
      @if (serviceList(); as serviceList ) {
      <div class="d-flex flex-column service-content">
        <strong class="mb-3"
          ><span [transloco]="I18N_PREFFIX + 'service-title'"></span
        ></strong>
        <mat-form-field appearance="outline">
          <mat-label
            ><span [transloco]="I18N_PREFFIX + 'service-label'"></span
          ></mat-label>
          <mat-select [formControl]="newAppointmentForm.controls.serviceId">
            @if (isServiceLoading()) {
            <mat-option [disabled]="true">
              <div class="d-flex align-items-center">
                <lib-spinner />
              </div>
            </mat-option>
            } @else { @for (service of serviceList; track service.documentId) {
            <mat-option [value]="service.documentId">
              <div class="d-flex align-items-center column-gap-2">
                <img
                  class="service-photo rounded-circle"
                  [src]="service.photo?.url | getImgUrl"
                  alt="User photo"
                />
                <span>{{ service.name }}</span>
              </div>
            </mat-option>
            } }
          </mat-select>
          @if (newAppointmentForm.controls.serviceId.touched &&
          newAppointmentForm.controls.serviceId.errors) {
          <mat-error
            >{{
              newAppointmentForm.controls.serviceId
                | validationError : (I18N_PREFFIX + "service-label" | transloco)
                | async
            }}
          </mat-error>
          }
        </mat-form-field>
      </div>
      }

      <!-- Client section -->
      <div class="d-flex flex-column">
        <div class="mb-3 d-flex flex-column align-items-start">
          <strong class="d-flex column-gap-2"
            ><span [transloco]="I18N_PREFFIX + 'client-title'"></span>
            <mat-icon
              #tooltip="matTooltip"
              (click)="tooltip.toggle()"
              [matTooltip]="I18N_PREFFIX + 'client-view-help' | transloco"
              matTooltipPosition="below"
              matTooltipClass="custom-tooltip"
            >
              help
            </mat-icon>
          </strong>
          <mat-button-toggle-group
            appearance="standard"
            class="mt-2"
            [ngModelOptions]="{ standalone: true }"
            (ngModelChange)="onClientViewChange($event)"
            [ngModel]="clientView()"
            aria-label="Font Style"
          >
            <mat-button-toggle [value]="IClientView.REGISTERED">
              <span [transloco]="I18N_PREFFIX + 'mat-button-registered'"></span>
            </mat-button-toggle>

            <mat-button-toggle [value]="IClientView.NON_REGISTERED">
              <span [transloco]="I18N_PREFFIX + 'mat-button-guest'"></span>
            </mat-button-toggle>

            @if (!isEditMode) {
            <mat-button-toggle [value]="IClientView.NEW_CLIENT">
              <span [transloco]="I18N_PREFFIX + 'mat-button-new'"></span>
            </mat-button-toggle>
            }
          </mat-button-toggle-group>
        </div>

        @switch (clientView()) { @case (IClientView.NEW_CLIENT) {
        <div>
          <lib-input
            placeholder="Email"
            [type]="IInputType.EMAIL"
            [label]="I18N_PREFFIX + 'new-client-view.email-label' | transloco"
            [formControlRef]="newClientForm.controls.email"
          >
          </lib-input>
        </div>
        <div>
          <lib-input
            placeholder="Username"
            [label]="
              I18N_PREFFIX + 'new-client-view.username-label' | transloco
            "
            [formControlRef]="newClientForm.controls.username"
          >
          </lib-input>
        </div>
        <div>
          <lib-telephone-input
            inputId="userTelephone"
            [placeholder]="
              I18N_PREFFIX + 'new-client-view.phone-label' | transloco
            "
            [formControlRef]="newClientForm.controls.telephone"
          >
          </lib-telephone-input>
        </div>
        } @case (IClientView.NON_REGISTERED) {
        <div>
          <lib-input
            placeholder="Nome"
            [label]="I18N_PREFFIX + 'name-label' | transloco"
            [formControlRef]="nonRegisteredUserForm.controls.name"
          >
          </lib-input>
        </div>
        <div>
          <lib-telephone-input
            inputId="firstTelephone"
            [placeholder]="I18N_PREFFIX + 'telephone-label' | transloco"
            [formControlRef]="nonRegisteredUserForm.controls.telephone"
          >
          </lib-telephone-input>
        </div>
        } @case (IClientView.REGISTERED) {
        <mat-form-field appearance="outline">
          <mat-label
            ><span [transloco]="I18N_PREFFIX + 'username-label'"></span
          ></mat-label>
          <input
            #clientListInput
            type="text"
            [placeholder]="I18N_PREFFIX + 'username-placeholder' | transloco"
            matInput
            [formControl]="registeredUserForm"
            (input)="getClientList()"
            [matAutocomplete]="auto"
          />
          <mat-autocomplete
            [displayWith]="displayFn"
            requireSelection
            #auto="matAutocomplete"
          >
            @if (isClientLoading()) {
            <mat-option [disabled]="true">
              <div class="d-flex align-items-center">
                <lib-spinner />
              </div>
            </mat-option>

            } @else { @for (client of clientList(); track client) {
            <mat-option [value]="client">
              <div class="d-flex align-items-center column-gap-2">
                <img
                  class="client-photo rounded-circle"
                  [src]="
                    client.photo?.url | getImgUrl : '/assets/icons/avatar.svg'
                  "
                  alt="User photo"
                />
                <span>{{ client.username }}</span>
              </div>
            </mat-option>
            } @empty { @if (hasRequestedClientList()) {
            <mat-option [disabled]="true">
              <span [transloco]="I18N_PREFFIX + 'no-user-msg'"></span>
            </mat-option>
            } } }
          </mat-autocomplete>
          @if (registeredUserForm.touched && registeredUserForm.errors) {
          <mat-error
            >{{
              registeredUserForm
                | validationError
                  : (I18N_PREFFIX + "username-label" | transloco)
                | async
            }}
          </mat-error>
          }
        </mat-form-field>
        } }
      </div>

      <!-- Slot section -->
      @if (!!newAppointmentForm.controls.serviceId.value) { @if (isLoading()) {
      <div class="content-slots">
        <lib-spinner />
      </div>
      } @else {
      <div class="d-flex flex-column content-slots">
        <div class="mb-2 d-flex justify-content-between align-items-center">
          <strong
            ><span [transloco]="I18N_PREFFIX + 'time-title'"></span
          ></strong>
          <mat-checkbox
            color="primary"
            class="me-2"
            (ngModelChange)="onSlotViewChange($event)"
            [ngModelOptions]="{ standalone: true }"
            [ngModel]="isAccommodationSlotView()"
            ><span [transloco]="I18N_PREFFIX + 'accommodation'"></span>
          </mat-checkbox>
        </div>
        @if (!isAccommodationSlotView()) {
        <mat-chip-listbox
          ariaOrientation="vertical"
          aria-label="slot selection"
        >
          @for (slot of freeSlotsList(); track $index; let first = $first) {
          <mat-chip-option
            [selectable]="true"
            [value]="slot"
            (selectionChange)="slotChange($event, slot)"
            [selected]="first"
          >
            <mat-icon matChipAvatar> schedule </mat-icon>
            {{ slot.startTime }}
          </mat-chip-option>
          } @empty {
          <div
            class="d-flex flex-column align-items-center text-center content-slots w-100"
          >
            <p class="mt-2 ms-2">
              <span [transloco]="I18N_PREFFIX + 'no-time-msg'"></span>
            </p>
            <img src="/assets/icons/pictogram-no-results-found.svg" alt="" />
          </div>
          }
        </mat-chip-listbox>
        } @else {
        <div class="row">
          <div class="col-6">
            <lib-input
              [label]="I18N_PREFFIX + 'start-time-label' | transloco"
              [formControlRef]="accommodationSlotForm.controls.startTime"
              [type]="IInputType.TIME"
            >
            </lib-input>
          </div>
          <div class="col-6">
            <lib-input
              [label]="I18N_PREFFIX + 'end-time-label' | transloco"
              [formControlRef]="accommodationSlotForm.controls.endTime"
              [type]="IInputType.TIME"
            >
            </lib-input>
          </div>
        </div>
        }
      </div>
      } } @else {
      <div class="d-flex align-items-center column-gap-2 content-slots">
        <mat-icon class="flex-shrink-0">info</mat-icon>
        <span
          ><span [transloco]="I18N_PREFFIX + 'select-service-msg'"></span
        ></span>
      </div>
      }
    </form>
  </ng-container>

  <ng-container slot="modal-actions">
    @if(isCreationAppointmentLoading()) {
    <lib-spinner></lib-spinner>
    } @else {
    <button mat-button (click)="close()">
      <span [transloco]="I18N_PREFFIX + 'cancel'"></span>
    </button>
    <button
      [disabled]="
        newAppointmentForm.invalid ||
        !selectedSlot().startTime ||
        !selectedSlot().endTime
      "
      mat-raised-button
      (click)="createAndEditAppointment()"
      color="primary"
      cdkFocusInitial
    >
      <span [transloco]="I18N_PREFFIX + (isEditMode ? 'edit' : 'book')"></span>
    </button>
    }
  </ng-container>
</lib-modal-body>
